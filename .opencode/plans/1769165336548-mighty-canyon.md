# Zellij-Style Multiplexer Plan

## Goal
Add a zellij-like multiplexer mode with windows + panes (compact layout: panes above, window tabs along the bottom). Each pane runs its own PTY. Splits are even halves only (no resizing). Keep the current “classic” sidebar layout available behind a config flag.

## Approach
### 1) Config + Types (toggle + data model)
- Add `layout: "classic" | "zellij"` to config schema + types (`src/lib/config.ts`, `src/types/index.ts`) with default `classic`.
- Introduce window/pane types for runtime + session persistence:
  - `PaneId`, `WindowId`, `PaneLayoutNode`, `WindowState`, `RunningPane`, and `SessionWindowData`/`SessionPaneData` (`src/types/index.ts`).
- Update docs/config for the new layout flag and keybinds (`docs/configuration.md` if present).

### 2) IPC + Session Server/Client (window + pane lifecycle)
- Extend IPC types with pane/window operations (`src/lib/ipc.ts`):
  - Client: `create_window`, `split_pane`, `close_pane`, `close_window`, `set_active_window`, `set_active_pane`, `resize_pane`.
  - Server: `window_changed`, `window_closed`, `active_window`, `active_pane`, and `pane_*` updates.
- Session client methods to send those operations (`src/lib/session-client.ts`).
- Session server split into classic vs zellij modes (`src/lib/session-server.ts`):
  - `startZellijSessionServer` manages `windows`, `runningPanes`, active window/pane.
  - On split: replace leaf with a split node and start a new PTY for the new pane.
  - On close: prune layout; if last pane in window, close window.
  - Persist/restore windows/panes + active ids in session file (`src/lib/session.ts`).

### 3) Layout Utilities (even splits)
- Add layout helpers for pane tree transforms + sizing (`src/lib/layout.ts`):
  - `buildSplitNode`, `replacePaneLeaf`, `removePaneLeaf`, `collectPaneIds`.
  - `computePaneRects` for even-split sizes used to resize PTYs.

### 4) UI + Stores (compact layout)
- Add window/pane store (`src/stores/windows.ts`) holding windows, active ids, focus mode, and pane buffers.
- Create pane rendering components:
  - `src/components/PaneView.tsx` for a bordered pane + ghostty terminal.
  - `src/components/PaneLayout.tsx` to recursively render split nodes.
  - `src/components/WindowBar.tsx` for bottom tabs (window titles, active highlight).
- Update `src/app.tsx` to branch on layout mode:
  - **Classic**: keep `TabList` + `TerminalPane` unchanged.
  - **Zellij**: render `PaneLayout` and `WindowBar` (compact layout).
  - Wire keybinds for manager mode: split vertical/horizontal, new window, close pane/window, cycle windows/panes; `Ctrl+A` toggles manager vs terminal focus.
  - Route input to active pane when in terminal focus; resize each pane on terminal resize using `computePaneRects`.
- Update `src/components/StatusBar.tsx` to show correct key hints per layout/focus.

## Verification
1) `bun run dev`
   - Set `layout: zellij` in `tuidoscope.yaml`.
   - Create windows, split panes vertically/horizontally, and verify even splits.
   - Confirm bottom window tabs and pane focus switching; ensure PTY input goes to active pane.
2) `bun run typecheck`
3) `bun run build`

## Key Files
- `src/app.tsx`
- `src/types/index.ts`
- `src/lib/config.ts`
- `src/lib/ipc.ts`
- `src/lib/session-server.ts`
- `src/lib/session-client.ts`
- `src/lib/session.ts`
- `src/lib/layout.ts`
- `src/stores/windows.ts`
- `src/components/PaneLayout.tsx`
- `src/components/PaneView.tsx`
- `src/components/WindowBar.tsx`
- `src/components/StatusBar.tsx`
