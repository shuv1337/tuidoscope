# Plan: Add window + pane support (zellij compact-like)

## Goals
- Introduce a window + pane model with even split layouts (no resizing).
- Add a bottom tab bar for windows (zellij compact-like).
- Each pane spawns its own PTY process.
- Keep the existing sidebar layout behind a config toggle (experimental zellij layout).
- Provide keybindings/commands for split and window management.

## Assumptions
- New panes/windows should clone the active pane's AppEntry (per user choice).
- Zellij layout is opt-in via config; classic layout remains default.

## Data model changes
- Add new runtime types in `src/types/index.ts`:
  - `PaneId`, `WindowId` (string aliases).
  - `PaneLayoutNode` (tree):
    - `{ type: "leaf"; paneId: PaneId }`
    - `{ type: "split"; direction: "horizontal" | "vertical"; children: [PaneLayoutNode, PaneLayoutNode] }`
  - `WindowState` (id, title, layout, activePaneId).
  - `RunningPane` (paneId + RunningApp-like fields, uses existing `AppEntry`).
  - `SessionWindowData` + `SessionPaneData` for persistence (see session section).

## Store updates
- Add a new store (e.g. `src/stores/windows.ts`) for the zellij layout:
  - State: `windows: WindowState[]`, `activeWindowId`, `activePaneId`, `focusMode` (reuse `FocusMode`).
  - Pane map: `runningPanes: Map<PaneId, RunningPane>`.
  - Actions:
    - `setActiveWindow(id)` + `setActivePane(id)`.
    - `createWindow(entry)` (creates window + first pane).
    - `splitPane(direction, entry)` (replaces active leaf with split node, adds new pane).
    - `closePane(id)` (remove pane, collapse tree; close window if last pane).
    - `closeWindow(id)` + `nextWindow/prevWindow` + `nextPane/prevPane`.
    - `appendPaneBuffer`, `updatePaneStatus`, `setRunningPanes`.
- Keep `src/stores/tabs.ts` for classic layout; App chooses store based on config.

## Config toggle
- Extend `Config` and `ConfigSchema` in `src/types/index.ts` + `src/lib/config.ts`:
  - Add `layout: "classic" | "zellij"` (default `"classic"`).
  - Alternatively a boolean `experimental_zellij_layout`; pick one and keep defaults stable.
- Update `saveConfig`/`loadConfig` to persist the new flag without breaking existing config files.

## IPC protocol changes
- Update `src/lib/ipc.ts` message shapes to support windows/panes:
  - `snapshot` → include windows + panes + activeWindowId + activePaneId.
  - New client messages: `create_window`, `split_pane`, `close_pane`, `close_window`,
    `set_active_window`, `set_active_pane`, `resize_pane`.
  - New server messages: `window_changed`, `pane_started`, `pane_stopped`, `pane_output`,
    `pane_status`, `active_window`, `active_pane` (or fold into a single `layout_update`).
- Keep existing messages for classic layout to avoid breaking the legacy UI; gate by layout mode.

## Session server changes
- Refactor `src/lib/session-server.ts` to maintain a window/pane model when `layout === "zellij"`:
  - Track `windows: Map<WindowId, WindowState>` and `runningPanes: Map<PaneId, ServerRunningApp>`.
  - `split_pane` clones active pane's AppEntry and spawns a new PTY with the latest known size.
  - `create_window` creates a new window with a single pane (cloned AppEntry).
  - `close_pane` kills its PTY; collapse the layout tree and close window if empty.
  - `resize_pane` resizes the specific PTY (store last size per pane for new panes).
  - Broadcast layout + running pane snapshots to all clients.
- Keep existing tab-centric logic for classic layout path.

## Session client changes
- Update `src/lib/session-client.ts` API to match new IPC messages:
  - `createWindow(entry)`, `splitPane(paneId, direction, entry)`, `closePane(paneId)`.
  - `setActiveWindow(id)`, `setActivePane(id)`.
  - `resizePane(paneId, cols, rows)`.
- Preserve legacy methods (`start`, `stop`, `setActiveTab`, etc.) for classic layout.

## Rendering and layout computation
- Add a pane renderer for the zellij layout (new component suggested):
  - `src/components/PaneLayout.tsx` recursively renders `PaneLayoutNode`.
  - `PaneView` (could be reuse/extend `TerminalPane`) renders a single pane buffer with border + header.
- Layout computation helper (new file, e.g. `src/lib/layout.ts`):
  - `computePaneRects(layout, width, height)` returns leaf rects.
  - Split direction:
    - vertical: divide width evenly, same height.
    - horizontal: divide height evenly, same width.
  - Use integer math (floor) and distribute remainder to the last child to avoid gaps.
- In `src/app.tsx`, branch on config flag:
  - **Classic**: keep TabList + TerminalPane + StatusBar path unchanged.
  - **Zellij**: render `PaneLayout` above a new `WindowBar` component (bottom row).
    - Keep `StatusBar` (1 row) above `WindowBar` or merge hints into `WindowBar`.
    - `WindowBar` shows window titles, active window highlight, active pane indicator.
- Input routing:
  - In terminal focus mode, send input to active pane id.
  - In manager focus mode, handle new split/window keybindings.
- Resize handling:
  - Use terminal dimensions to compute pane sizes each effect.
  - Send `resize_pane` for each pane based on its computed content cols/rows.

## Status bar + keybindings (zellij mode)
- Update `src/components/StatusBar.tsx` to show zellij-specific hints when layout flag is on.
- Suggested keybindings in manager mode:
  - `v`: split vertical
  - `s`: split horizontal
  - `n`: new window (clone active app)
  - `x`: close pane
  - `w`: close window
  - `[` / `]`: previous/next window
  - `p`: cycle panes in active window
  - `Ctrl+A`: toggle terminal focus (keep existing behavior)
- Optional: add Command Palette entries for “Split Vertical/Horizontal”, “New Window”, “Close Pane”.

## Session persistence updates
- Extend `SessionData` in `src/types/index.ts` to store windows/panes:
  - `windows: SessionWindowData[]`, `activeWindowId`, `activePaneId`.
  - Each `SessionWindowData` stores layout + pane references + title.
  - Each `SessionPaneData` stores AppEntry ref and (optional) last known size.
- Update `src/lib/session.ts` to load/save new format; keep compatibility with existing
  `runningApps`/`activeTab` by migrating to a single window + single pane.
- Update `src/lib/session.test.ts` to cover new format and backward compatibility.

## Files to change / add
- `src/app.tsx`
- `src/components/TerminalPane.tsx` (or new `PaneView.tsx`)
- `src/components/TabList.tsx`, `src/components/TabItem.tsx` (classic path only)
- `src/components/StatusBar.tsx`
- `src/components/WindowBar.tsx` (new)
- `src/components/PaneLayout.tsx` (new)
- `src/stores/windows.ts` (new)
- `src/stores/tabs.ts` (retain for classic)
- `src/lib/layout.ts` (new layout calculations)
- `src/lib/ipc.ts`
- `src/lib/session-server.ts`
- `src/lib/session-client.ts`
- `src/lib/session.ts` + `src/lib/session.test.ts`
- `src/lib/config.ts`
- `src/types/index.ts`

## Verification
- `bun run dev` (exercise classic + zellij modes; split panes, new windows).
- `bun run typecheck`.
- `bun run build`.
